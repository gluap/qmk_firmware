/* A standard layout for the Dactyl Manuform 5x6 Keyboard */

#include QMK_KEYBOARD_H
#include <keymap_german.h>
#include <stdlib.h>
#include <config.h>


#define _QWERTY 0
#define _LOWER 1
#define _RAISE 2

#define RAISE MO(_RAISE)
#define LOWER MO(_LOWER)

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

  [_QWERTY] = LAYOUT_5x6(
      KC_1   , KC_2  , KC_3  , KC_4  , KC_5  ,  KC_6  ,                         KC_7  , KC_8  , KC_9  , KC_0  , DE_SS,   DE_ACUT,
      KC_TAB , KC_Q  , KC_W  , KC_E  , KC_R  , KC_T  ,                          KC_Y  , KC_U  , KC_I  , KC_O  , KC_P   , DE_UDIA,
      DE_CIRC, KC_A  , KC_S  , KC_D  , KC_F  , KC_G  ,                          KC_H  , KC_J  , KC_K  , KC_L  ,DE_ODIA , DE_ADIA,
      DE_LABK, KC_Z  , KC_X  , KC_C  , KC_V  , KC_B  ,                          KC_N  , KC_M  ,DE_COMM,KC_DOT ,DE_MINS , DE_HASH,
                    MT(MOD_LALT,KC_DEL) , MT(MOD_LCTL,KC_ESC),                                 DE_PLUS, DE_BSLS,
                                        MT(MOD_LALT,KC_DEL),MO(_RAISE),                      KC_LGUI,  MT(MOD_RALT,KC_ENTER),
                                        MT(MOD_LSFT,KC_BSPC), MO(_LOWER),                        MT(MOD_LCTL,KC_TAB), KC_SPC
  ),
  [_LOWER] = LAYOUT_5x6(

     KC_TILD,KC_EXLM, KC_AT ,KC_HASH,KC_DLR ,KC_PERC,                        KC_CIRC,KC_AMPR,KC_ASTR,KC_LPRN,KC_RPRN,KC_DEL,
     _______,_______,_______,_______,_______,DE_LBRC,                        DE_RBRC, _______ ,_______ ,_______ ,_______,KC_PLUS,
     _______,KC_HOME,KC_PGUP,KC_PGDN,KC_END ,DE_LPRN,                        DE_RPRN, KC_HOME , KC_PGUP ,KC_PGDN ,KC_END,DE_PIPE,
     _______,_______,_______,_______,_______,DE_LCBR,                        DE_RCBR, _______ ,_______ ,_______ ,KC_EQL ,DE_UNDS,
                    _______,KC_PSCR,                                                            _______, KC_P0,

                                             _______,_______,            _______,_______,
                                             _______,_______,            _______,_______
  ),

  [_RAISE] = LAYOUT_5x6(
       KC_F1 , KC_F2 , KC_F3 , KC_F4 , KC_F5 , KC_F6 ,                        KC_F7  , KC_F8 , KC_F9 , KC_F10 ,KC_F11 ,KC_F12,
       KC_CAPS,_______,_______,_______,_______,DE_LBRC,                       DE_RBRC,_______,_______,KC_INS ,_______,KC_MUTE,
       KC_NUM ,KC_LEFT,KC_UP  ,KC_DOWN,KC_RGHT,DE_LPRN,                       DE_RPRN,KC_LEFT,KC_UP  ,KC_DOWN,KC_RGHT,KC_VOLU,
       KC_SCRL,_______,_______,_______,_______,DE_LCBR,                       DE_RCBR,_______,_______,_______,_______,KC_VOLD,
                       _______,_______,                                                        KC_EQL ,_______,

                                               _______,_______,            _______,_______,
                                               _______,_______,            _______,_______
  ),
};
int timer = 0;
int timer2 = 0;
int timer_invert = 0;
int last_typing = 0;
bool logo= false;
char wpm_text[5]="asdf";
int x = 64;
int currwpm = 0;

//USER CONFIG PARAMS
float max_wpm = 140.0f; //WPM value at the top of the graph window
int graph_refresh_interval = 160; //in milliseconds
int graph_area_fill_interval = 64;

#ifdef OLED_ENABLE
static void render_logo(void) {
    static const char PROGMEM raw_logo[] =  {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
    0xE0, 0x30, 0x18, 0x0C, 0x04, 0x04,
    0x06, 0x06, 0x06, 0x06, 0x04, 0x0C,
    0x0C, 0x0C, 0x0C, 0x04, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x04, 0x04, 0x08,
    0x18, 0x30, 0x20, 0xC0, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xC0, 0x20, 0x20, 0x20, 0xE0,
    0x20, 0x00, 0xE8, 0x00, 0x00, 0xF0,
    0x20, 0x20, 0x00, 0xFC, 0x40, 0x20,
    0x20, 0xE0, 0x00, 0x00, 0xE0, 0x00,
    0x00, 0x00, 0xE0, 0x00, 0x00, 0xFC,
    0x40, 0x20, 0x20, 0x60, 0x80, 0x00,
    0x00, 0x00, 0x00, 0xC0, 0x20, 0x20,
    0x20, 0x20, 0x00, 0xC0, 0x20, 0x20,
    0x20, 0x40, 0x80, 0x00, 0xE0, 0x40,
    0x20, 0x20, 0xE0, 0x40, 0x20, 0x20,
    0xE0, 0x00, 0x00, 0x80, 0x70, 0x0C,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xE0, 0x1C,
    0x06, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x0E, 0x38, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3A, 0x25, 0x25,
    0x25, 0x24, 0x18, 0x00, 0x07, 0x00,
    0x00, 0x03, 0x04, 0x04, 0x00, 0x07,
    0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
    0x03, 0x04, 0x04, 0x04, 0x07, 0x00,
    0x00, 0x07, 0x02, 0x04, 0x04, 0x06,
    0x01, 0x00, 0x06, 0x00, 0x00, 0x03,
    0x04, 0x04, 0x04, 0x04, 0x00, 0x03,
    0x04, 0x04, 0x04, 0x02, 0x01, 0x00,
    0x07, 0x00, 0x00, 0x00, 0x07, 0x00,
    0x00, 0x00, 0x07, 0x00, 0x04, 0x03,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xC0, 0x60, 0x10, 0x10, 0x18, 0x08,
    0x04, 0x04, 0x06, 0x82, 0x82, 0xC2,
    0xF3, 0xF1, 0xF3, 0xF2, 0xF2, 0xF2,
    0xF3, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1,
    0xF1, 0xF2, 0xF2, 0xF3, 0xF1, 0xF1,
    0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1,
    0xF1, 0xF1, 0xF1, 0xF1, 0xF3, 0xF2,
    0xF2, 0xF6, 0xE4, 0xE4, 0xE4, 0xC5,
    0xC7, 0x8C, 0x08, 0x08, 0x08, 0x10,
    0x10, 0x30, 0x20, 0x60, 0x40, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x80, 0x40, 0x40, 0x40, 0xC0,
    0x40, 0x00, 0xF8, 0x00, 0x00, 0xC0,
    0x00, 0x00, 0x00, 0xC0, 0x00, 0x00,
    0x00, 0x40, 0x40, 0x40, 0xC0, 0x00,
    0x00, 0xC0, 0x80, 0x40, 0x40, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0x1C, 0x10, 0x30, 0x20,
    0x20, 0xA0, 0xF8, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x7F, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x7F, 0x7F, 0x3F, 0xBF, 0xBF, 0x3F,
    0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE,
    0xF0, 0xE0, 0x30, 0x10, 0x10, 0x18,
    0x0C, 0x07, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x75, 0x4A, 0x4A,
    0x4A, 0x49, 0x30, 0x00, 0x0F, 0x00,
    0x00, 0x07, 0x08, 0x08, 0x08, 0x0F,
    0x00, 0x00, 0x0E, 0x09, 0x09, 0x09,
    0x0F, 0x00, 0x00, 0x7F, 0x04, 0x08,
    0x08, 0x0C, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xF0,
    0xF1, 0xF3, 0x0F, 0xFF, 0xFF, 0xFF,
    0x03, 0x78, 0xFE, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xF8, 0xF8, 0xF8, 0x01,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xC0, 0xE0, 0xE0, 0xE0,
    0xFC, 0xFC, 0xE0, 0xFC, 0xFC, 0xE0,
    0xFC, 0xFC, 0xE0, 0xFC, 0xFC, 0xE0,
    0xFC, 0xFC, 0xE0, 0xE0, 0xE0, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x1F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFE, 0xBE, 0x3E, 0x3E,
    0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3F,
    0x3F, 0x3F, 0x3F, 0x3F, 0x3E, 0x3E,
    0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E,
    0x3E, 0x3E, 0x7F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xB6, 0xB6, 0xB6, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x01, 0x01, 0xFF,
    0xFF, 0xFF, 0x01, 0x01, 0xFF, 0xFF,
    0xFF, 0x01, 0x01, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xB6, 0xB6, 0xB6, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F,
    0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFE, 0xF8, 0xF0, 0xE0, 0xC0, 0x80,
    0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0,
    0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0x60, 0x00, 0x80, 0xC0, 0xF8, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x07,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x6D, 0x6D, 0x6D,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
    0xF8, 0xF9, 0xF3, 0xF3, 0x80, 0x80,
    0xF3, 0xF3, 0xF9, 0xF8, 0xFC, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0x6D, 0x6D,
    0x6D, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x03,
    0x07, 0x0F, 0x1F, 0x3F, 0x3F, 0x7F,
    0x7F, 0x7F, 0x7F, 0x7F, 0x7E, 0x7E,
    0x7E, 0x7E, 0xFE, 0xFE, 0xFE, 0xFE,
    0xFE, 0x7E, 0x7E, 0x7F, 0x7F, 0x7F,
    0x7F, 0x7F, 0x3F, 0x3F, 0x0F, 0x07,
    0x07, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x03, 0x07, 0x07, 0x07,
    0x3F, 0x3F, 0x07, 0x3F, 0x3F, 0x07,
    0x3F, 0x3F, 0x07, 0x3F, 0x3F, 0x07,
    0x3F, 0x3F, 0x07, 0x07, 0x07, 0x03,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
};

    oled_write_raw_P(raw_logo, sizeof(raw_logo));
     oled_scroll_set_speed(4);

// Begin scrolling the entire display right
// Returns true if the screen was scrolling or starts scrolling
// NOTE: display contents cannot be changed while scrolling
 oled_scroll_left();
 oled_set_brightness(8);
}

void disable_logo(void) {
    if (logo) {
        logo = false;
        oled_clear();
        oled_scroll_off();
        oled_set_brightness(255);
    }
}

bool oled_task_user(void) {

	//get current WPM value
	currwpm = get_current_wpm();
    itoa(currwpm ,wpm_text, 10);


	//check if it's been long enough before refreshing graph
	if((timer_elapsed(timer) > graph_refresh_interval) && (timer_elapsed(last_typing) < 128*graph_refresh_interval)){

		// main calculation to plot graph line
		x = 64- ((currwpm / max_wpm) * 48);

		//first draw actual value line
		oled_write_pixel(1, x, true);

		//then fill in area below the value line
		for(int i = 60; i > x; i-=2){
			if(i % graph_area_fill_interval == 0){
				oled_write_pixel(1, i, true);
			}
		}

		//then move the entire graph one pixel to the right
		oled_pan(false);

		//refresh the timer for the next iteration
		timer = timer_read();

	} else if  (timer_elapsed(last_typing) > 128*graph_refresh_interval) {
        render_logo();
        logo = true;
    }


	//format current WPM value into a printable string


	//formatting for triple digit WPM vs double digits, then print WPM readout
	if(currwpm>100){
		oled_set_cursor(13, 7);
		oled_write(" WPM: ", false);
		oled_set_cursor(18, 7);
		oled_write(wpm_text, false);
		last_typing = timer_read();
		disable_logo();
	} else if (currwpm >= 10){
		oled_set_cursor(14, 7);
		oled_write(" WPM: ", false);
		oled_set_cursor(19, 7);
		oled_write(wpm_text, false);
		last_typing = timer_read();
		disable_logo();

	} else if (currwpm>0) {
		oled_set_cursor(15, 7);
		oled_write(" WPM: ", false);
        oled_set_cursor(20, 7);
		oled_write(wpm_text, false);
		last_typing = timer_read();
		disable_logo();
	}


    oled_set_cursor(0, 0);
      // Host Keyboard Layer Status

    if (logo) {
        return false;
    }

    switch (get_highest_layer(layer_state)) {
        case _QWERTY:
            oled_write_P(PSTR("        "), false);
            break;
        case _RAISE:
            oled_write_P(PSTR("Arrows"), false);
            break;
        case _LOWER:
            oled_write_P(PSTR("PGUPDOWN"), false);
            break;
    }

    // Host Keyboard LED Status
    led_t led_state = host_keyboard_led_state();
    if((led_state.num_lock  || led_state.caps_lock || led_state.scroll_lock) ){
        oled_set_cursor(1, 1);
    oled_write_P(led_state.num_lock ? PSTR(" NUM") : PSTR("    "), false);
    oled_write_P(led_state.caps_lock ? PSTR(" CAP") : PSTR("    "), false);
    oled_write_P(led_state.scroll_lock ? PSTR(" SCR") : PSTR("    "), false);
    }
  return false;
}


void oled_render_boot(bool bootloader) {
    oled_clear();
    for (int i = 0; i < 16; i++) {
        oled_set_cursor(0, i);
        if (bootloader) {
            oled_write_P(PSTR("Awaiting New Firmware "), false);
        } else {
            oled_write_P(PSTR("Rebooting "), false);
        }
    }

    oled_render_dirty(true);
}

#endif
